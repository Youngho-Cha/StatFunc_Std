---
title: "Requirement-Specification"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Requirement-Specification}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# library(Survival.metrics)
```

# 1. calc_surv_rate

## 1.1 Overview
This function calculates group-specific survival rates at a predefined follow-up time and tests for differences between the survival distributions using the log-rank test.\ 

It is not intended to be a new implementation of survival analysis algorithms; rather, it serves as a standardized wrapper for validated functions from the `survival` package to improve the efficiency and consistency of repetitive coding tasks.

## 1.2 Input
* `time_event`: 
  + A numeric vector representing the time until the event of interest (e.g., death, recurrence) occurred.

* `time_follow`: 
  + A single numeric value specifying the follow-up time point at which the survival rate is to be calculated.

* `censored`: 
  + A numeric vector indicating the censoring status for each observation. 
  + By convention, 1 indicates that the event occurred, and 0 indicates the data was censored.

* `class`: 
  + A factor or character vector used to divide the data into two groups for comparison.

## 1.3 Processing Logic
1. Estimates the Kaplan-Meier survival curves for each group by calling the `survival::survfit` function with the `time_event`, `censored`, and `class` inputs.

2. From the fitted survival object, it extracts the survival rate and the corresponding confidence interval for each group at the time point specified by `time_follow`.

3. Performs a log-rank test to compare the survival distributions between groups using the `survival::survdiff` function.

4. Extracts the p-value from the log-rank test result.

5. Organizes the extracted survival information for each group, the p-value, and the original `survfit` object into a single list to be returned as the final output.

## 1.4 Output
The function returns a **list** object containing the following four named elements:

* class0: A data frame with the survival rate information for the first group.
* class1: A data frame with the survival rate information for the second group.
* p: A data frame containing the p-value from the log-rank test.
* km: The original survfit object generated by the survival::survfit function.

The class0 and class1 **data frames** consist of the following columns:

* time: The specified follow-up time (time_follow).
* surv_rate: The calculated survival rate at that time.
* lower: The lower bound of the confidence interval for the survival rate.
* upper: The upper bound of the confidence interval for the survival rate.

## 1.5 Error & Exception Handling
* **Missing Required Arguments:** 
  + The function will stop execution if the mandatory arguments, `time_event` or `censord` or `class` are not provided.
  
* **Mismatched Input Lengths**: 
  + The function will stop and throw an error if the lengths of the `time_event`, `censored`, and `class` vectors are not identical.

* **Invalid Number of Groups**: 
  + The function requires the `class` argument to have exactly two distinct groups. 
  + It will stop with an error if one, or more than two, groups are provided.

* **Incorrect Input Data Types**: 
  + The arguments `time_event`, `time_follow`, and censored must be numeric, while `class` must be a factor or character vector. 
  + Supplying other data types may lead to unexpected errors.


# 2. calc_freq_rate

## 2.1 Overview
This function calculates the cumulative event frequency and rate for each group at multiple, user-defined time points (time_vector). It is used to understand the trend of event occurrences over time based on survival data.

## 2.2 Input
* `time_event`: 
  + A numeric vector representing the time until the event of interest (e.g., death, recurrence) occurred.

* `time_vector`: 
  + A numeric vector of specific time points at which the cumulative event frequency and rate will be calculated.

* `censored`: 
  + A numeric vector indicating the censoring status for each observation. 
  + By convention, 1 indicates that the event occurred, and 0 indicates the data was censored.

* `class`: 
  + A factor or character vector used to divide the data into two groups for comparison.

## 2.3 Processing Logic
1. Performs a Kaplan-Meier survival analysis for each group by calling the `survival::survfit` function with the `time_event`, `censored`, and `class` inputs.

2. From the analysis results, it calculates the cumulative frequency of events and the corresponding rate (as a proportion of the total subjects in that group) for each time point specified in `time_vector`.

3. The calculated time-point data for each group is formatted into a data frame, which is then returned as the final output in a list along with the original `survfit` object.

## 2.4 Output
The function returns a **list** object containing the following three named elements:

* class0: A data frame with the cumulative event information for the first group.
* class1: A data frame with the cumulative event information for the second group.
* km: The original survfit object generated by the survival::survfit function.

The class0 and class1 **data frames** consist of the following columns:

* time: The specified time points from time_vector.
* freq: The cumulative frequency of events up to that time point.
* rate: The cumulative rate (proportion) of events up to that time point.

## 2.5 Error & Exception Handling
* **Missing Required Arguments:** 
  + The function will stop execution if the mandatory arguments, `time_event` or `censord` or `class` are not provided.

* **Mismatched Input Lengths**: 
  + The function will stop and throw an error if the lengths of the `time_event`, `censored`, and `class` vectors are not identical.

* **Invalid Number of Groups**: 
  + The function requires the `class` argument to have exactly two distinct groups. 
  + It will stop with an error if one, or more than two, groups are provided.

* **Empty time_vector**: 
  + If an empty vector is provided for `time_vector`, the function will stop with an error as it cannot create the output data frame.

* **Incorrect Input Data Types**: 
  + The arguments `time_event`, `time_vector`, and `censored` must be numeric, while `class` must be a factor or character vector. Supplying other data types may lead to unexpected errors.

# 3. calc_rmst

## 3.1 Overview
This function calculates the Restricted Mean Survival Time (RMST) for each group up to a user-specified time point (time_follow).\ 

The purpose of this function is not to implement a new RMST calculation algorithm but to serve as a standardized wrapper for the validated `rmst2` function from the `survRM2` package. This approach aims to improve the efficiency and consistency of repetitive analytical tasks.

## 3.2 Input
* `time_event`: 
  + A numeric vector representing the time to event.

* `time_follow`: 
  + A single numeric value specifying the truncation time point (tau) for the RMST calculation.

* `censored`: 
  + A numeric vector indicating the event status. 
  + By convention, 1 indicates that the event occurred, and 0 indicates the data was censored.

* `class`: 
  + A vector that divides the data into two groups for comparison. 
  + This should be a numeric vector (coded as 0 and 1) or a factor.

## 3.3 Processing Logic
1. Calls the `survRM2::rmst2` function with the `time_event`, `censored`, `class`, and `time_follow` inputs to calculate the RMST for each group.

2. Extracts the RMST estimate (Est.) and its 95% confidence interval (lower .95, upper .95) for each group from the result object.

3. Formats the extracted values into a data frame for each group and returns them within a list as the final output.

## 3.4 Output
The function returns a **list** object containing the following two named elements:

* class0: A data frame with the RMST information for the first group.
* class1: A data frame with the RMST information for the second group.

Each **data frame** consists of the following columns:

* group: A character string identifying the group (e.g., "class0").
* rmst: The estimated RMST value.
* lower: The lower bound of the 95% confidence interval for the RMST.
* upper: The upper bound of the 95% confidence interval for the RMST.

## 3.5 Error & Exception Handling
* **Missing Required Arguments:** 
  + The function will stop execution if the mandatory arguments, `time_event` or `censord` or `class` or `time_follow` are not provided.

* **Mismatched Input Lengths**: 
  + The function will stop and throw an error if the lengths of the `time_event`, `censored`, and `class` vectors are not identical.

* **Invalid Number of Groups**: 
  + The function requires the `class` argument to have exactly two distinct groups. 
  + It will stop with an error if one, or more than two, groups are provided.

* **Invalid time_follow (tau) Value**: 
  + If the last observation in the dataset is censored, the function will throw an error if the `time_follow` (tau) value is set beyond the time of this last observation, as this would require extrapolation.

* **Incorrect Input Data Types**: 
  + The arguments `time_event`, `time_follow`, and `censored` must be numeric. 
  + For stable performance, the `class` argument should be a numeric vector (coded as 0 and 1) or a factor with two levels.

# 4. calc_hazard_ratio

## 4.1 Overview
This function calculates the Hazard Ratio (HR) between two groups using a Cox Proportional Hazards Model.\

Its purpose is not to implement a new statistical algorithm but to serve as a standardized wrapper for the validated `coxph` function from the `survival` package, thereby improving the efficiency and consistency of repetitive analytical tasks.

## 4.2 Input
* `time_event`: 
  + A numeric vector representing the time until the event of interest (e.g., death, recurrence) occurred.

* `censored`: 
  + A numeric vector indicating the event status for each observation. 
  + By convention, 1 indicates that the event occurred, and 0 indicates the data was censored.

* `class`: 
  + A factor or character vector used to divide the data into groups for comparison. 
  + The Cox model automatically treats the **first level** of this factor as the **reference group**.

## 4.3 Processing Logic
1. Fits a Cox Proportional Hazards model by calling the `survival::coxph` function with the `time_event`, `censored`, and `class` inputs.

2. Calculates the Hazard Ratio by exponentiating the model's coefficient, which represents the risk of the non-reference group relative to the reference group.

3. Formats the resulting Hazard Ratio into a data frame and returns it as the final output.

## 4.4 Output
The function returns a data frame containing a single column:

* ratio: The calculated Hazard Ratio value.

## 4.5 Error & Exception Handling
* **Missing Required Arguments:** 
  + The function will stop execution if the mandatory arguments, `time_event` or `censord` or `class` are not provided.

* **Mismatched Input Lengths**: 
  + The function will stop and throw an error if the lengths of the `time_event`, `censored`, and `class` vectors are not identical.

* **Invalid Number of Groups**: 
  + The function requires the `class` argument to have exactly two distinct groups. 
  + It will stop with an error if one, or more than two, groups are provided.

* **Absence of Events**: 
  + If there are no events in the dataset (i.e., all values in censored are 0), the function will stop with an error as the Hazard Ratio cannot be calculated.

* **Complete Separation**: 
  + In cases of extreme data distributions (e.g., all events in one group occur before any event in another), the Hazard Ratio estimate may diverge to infinity (Inf) or converge to 0, depending on which group is selected as the baseline.

* **Incorrect Input Data Types**: 
  + The arguments time_event and censored must be numeric, while class must be a factor or character vector. 
  + Supplying other data types may lead to unexpected errors.

# 5. calc_c_index

## 5.1 Overview
This function calculates the Concordance Index (C-index), a metric used to evaluate the predictive performance of a specific variable in a survival model.\ 

Its purpose is not to implement a new calculation algorithm but to serve as a standardized wrapper for validated functions from the `survival` and `survcomp` packages, thereby improving the efficiency and consistency of repetitive analytical tasks.

## 5.2 Input
* `time_event`: 
  + A numeric vector representing the time until the event of interest (e.g., death, recurrence) occurred.

* `censored`: 
  + A numeric vector indicating the event status for each observation. 
  + By convention, 1 indicates that the event occurred, and 0 indicates the data was censored.

* `class`: 
  + The predictor variable for which the C-index will be calculated. 
  + This can be a numeric (continuous) or factor (categorical) vector.

## 5.3 Processing Logic
1. Fits a Cox proportional hazards model by calling the `survival::coxph` function with the `time_event`, `censored`, and `class` inputs.

2. Predicts the risk score (linear predictor) for each observation from the fitted model.

3. Calculates the C-index and its corresponding confidence interval by passing the risk scores, survival times, and event statuses to the `survcomp::concordance.index` function.

4. Formats the resulting C-index and its confidence interval into a data frame and returns it as the final output.

## 5.4 Output
The function returns a **data frame** with the following columns:

* C_index: The calculated C-index value.
* lower: The lower bound of the confidence interval for the C-index.
* upper: The upper bound of the confidence interval for the C-index.

## 5.5 Error & Exception Handling
* **Missing Required Arguments:** 
  + The function will stop execution if the mandatory arguments, `time_event` or `censord` or `class` are not provided.

* **Mismatched Input Lengths**: 
  + The function will stop and throw an error if the lengths of the `time_event`, `censored` vectors are not identical.

* **Absence of Events**: 
  + If there are no events in the dataset (i.e., all values in `censored` are 0), the Cox model cannot be fitted, and the function will stop with an error.

* **Zero Variance in Predictor**: 
  + If the predictor variable (`class`) has zero variance (i.e., all its values are identical), the model cannot converge, and the function will stop with an error.

* **Complete Separation**: 
  + In cases where the predictor variable perfectly predicts the outcome, the underlying Cox model becomes unstable. This can lead to issues in the calculation, and the C-index may be returned as NA.

* **Incorrect Input Data Types**: 
  + The arguments `time_event` and `censored` must be numeric, while `class` should be a numeric or factor vector. 
  + Supplying other data types may lead to unexpected errors.

# 6. create_surv_plot

## 6.1 Overview
This function generates and saves a group-specific Kaplan-Meier survival plot based on a survfit object.\ 

It is designed to create a more aesthetically pleasing and customizable visualization than base R plotting functions by leveraging the `ggplot2` library.

## 6.2 Input
* `km_res`: 
  + A survfit object created by the survival::survfit function.

* `filepath`: 
  + A character string specifying the full path and filename for saving the plot (e.g., "plots/survival_curve.png").

* `title`: 
  + A character string for the plot's main title.

* `x`: 
  + A character string for the x-axis label.

* `y`: 
  + A character string for the y-axis label.

* `legend_title`: 
  + A character string for the legend title.

* `legend_labels`: 
  + A character vector of labels for each group in the legend.

## 6.3 Processing Logic
1. Converts the input `survfit` object into a tidy data frame suitable for `ggplot2` using the `broom::tidy` function.

2. Manually creates and prepends start-point data (time=0, survival=1) for each group to ensure the curves begin properly at 100% survival.

3. Constructs the plot layer by layer using `ggplot2: geom_step` is used to draw the Kaplan-Meier curves, and `geom_ribbon` displays the confidence intervals as a shaded area.

4. Applies user-defined customizations such as the title, axis labels, legend title, and legend labels using `labs` and `scale_*_discrete` functions.

5. Saves the final ggplot object to the specified `filepath` as an image file using the `ggsave` function.

## 6.4 Output
This function **does not return an R object**. Instead, it saves a survival curve plot as an **image file** to the location specified by the `filepath` argument.

## 6.5 Error & Exception Handling
* **Invalid km_res Object**: 
  + The function will throw an error if the km_res argument is not a survfit object or if it is a survfit object that lacks group (strata) information.

* **File Path Errors**: 
  + An error will occur during the saving process if the directory specified in `filepath` does not exist or if the program lacks write permissions for that location.

* **Mismatched Legend Labels**: 
  + The function will stop with an error if the number of elements in the `legend_labels` vector does not match the actual number of groups in the `km_res` object.


